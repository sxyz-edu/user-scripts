// ==UserScript==
// @name           Scripts for BZOJ
// @namespace      https://www.lydsy.com/
// @version        0.2.0
// @match          https://www.lydsy.com/JudgeOnline/*
// @run-at         document-start
// @updateURL      https://raw.githubusercontent.com/sxyz-edu/user-scripts/master/dist/bzoj.user.js
// @downloadURL    https://raw.githubusercontent.com/sxyz-edu/user-scripts/master/dist/bzoj.user.js
// @supportURL     https://github.com/sxyz-edu/user-scripts
// ==/UserScript==

"use strict";-1<location.href.indexOf("problem.php")&&(location.href=location.href.replace("problem.php","show.php")),setInterval(function(){fetch("/JudgeOnline/",{credentials:"same-origin"})},6e5),function(){var c=/p\((\d+)\);/gi,t=function(r){return new Promise(function(n,e){var t=localStorage.getItem(r);if(t)try{var o=JSON.parse(t);Number(new Date)-o.updateAt<=6e4&&n(o)}catch(e){console.error(e)}fetch("/JudgeOnline/userinfo.php?user=".concat(r)).then(function(e){return e.text()}).then(function(e){var t={passedlist:function(e){for(var t=[],n=c.exec(e);n;n=c.exec(e))t.push(n[1]);return t}(e),updateAt:Number(new Date)};localStorage.setItem(r,JSON.stringify(t)),n(t)}).catch(e)})};document.addEventListener("DOMContentLoaded",function(){if("/JudgeOnline/userinfo.php"===window.location.pathname){var e=document.querySelector("font[color]").innerText;"捐赠本站"!==e&&t(e).then(function(e){var n=new Set(e.passedlist);Array.from(document.querySelectorAll('a[href^="problem.php"]')).forEach(function(e){var t=e.innerText.trim();n.has(t)?e.style.color="#1fc51f":e.style.color="#ff6666"})})}})}(),document.addEventListener("DOMContentLoaded",function(){var e=[document.querySelector("title+center"),document.querySelector("div.content+center")],t=Number(location.href.split("=")[1]);5e3<=t||e.forEach(function(e){e&&(e.innerHTML+='[<a href="https://lydsy.download/archive/'.concat(t,'.zip">Download</a>]'))})}),function(){var p=function(e){return e.replace(/^Luogu(\d+)$/,"https://www.luogu.org/problemnew/show/P$1").replace(/^Loj(\d+)$/,"https://loj.ac/problem/$1").replace(/^Codevs(\d+)$/,"http://codevs.cn/problem/$1/").replace(/^Cogs(\d+)$/,"").replace(/^Vijos(\d+)$/,"https://vijos.org/p/$1")},h=function(e,t){return e?'<a href="'.concat(e,'" title="').concat(t,'" target="_blank">').concat(t,"</a>"):""},t=function(e){var t=Number(location.href.split("=")[1]),n=!0,o=!1,r=void 0;try{for(var c,a=e[Symbol.iterator]();!(n=(c=a.next()).done);n=!0){var i=c.value;if(Number(i[0])==t){var l=i[4],u=i[6],f=p(l),s=p(u),d=document.getElementsByTagName("h2")[0];(f||s)&&(d.innerHTML+=["<br>See Also:",h(f,l),h(s,u)].join(" "))}}}catch(e){o=!0,r=e}finally{try{n||null==a.return||a.return()}finally{if(o)throw r}}};document.addEventListener("DOMContentLoaded",function(){var e=localStorage.getItem("bzoj_json");e?t(JSON.parse(e)):fetch("https://ruanx.pw/bzojch/result.json").then(function(e){return e.json()}).then(function(e){localStorage.setItem("bzoj_json",JSON.stringify(e)),t(e)})})}();